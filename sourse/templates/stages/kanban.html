<!-- acceptance.html -->
{% extends 'templates/base.html' %}

{% block css %}
<style>
.stage {
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 10px;
}

.order {
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  padding: 5px;
  margin-bottom: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="stage" id="acceptance" data-url="/acceptance/">
  <h3>Acceptance</h3>
  {% for order in orders %}
  {% if order.stage == 'accepted' %}
  <div class="order" id="{{ order.id }}" draggable="true">{{ order.id }}</div>
  {% endif %}
  {% endfor %}
</div>

<div class="stage" id="database_loading" data-url="/database_loading/">
  <h3>Database Loading</h3>
  {% for order in orders %}
  {% if order.stage == 'database_loading' %}
  <div class="order" id="{{ order.id }}" draggable="true">{{ order.id }}</div>
  {% endif %}
  {% endfor %}
</div>

<div class="stage" id="unpacking" data-url="/unpacking/">
  <h3>Unpacking</h3>
  {% for order in orders %}
  {% if order.stage == 'unpacking' %}
  <div class="order" id="{{ order.id }}" draggable="true">{{ order.id }}</div>
  {% endif %}
  {% endfor %}
</div>

<div class="stage" id="quality_check" data-url="/quality_check/">
  <h3>Quality Check</h3>
  {% for order in orders %}
  {% if order.stage == 'quality_check' %}
  <div class="order" id="{{ order.id }}" draggable="true">{{ order.id }}</div>
  {% endif %}
  {% endfor %}
</div>

<div class="stage" id="invoice_generation" data-url="/invoice_generation/">
  <h3>Invoice Generation</h3>
  {% for order in orders %}
  {% if order.stage == 'invoice_generation' %}
  <div class="order" id="{{ order.id }}" draggable="true">{{ order.id }}</div>
  {% endif %}
  {% endfor %}
</div>

<div class="stage" id="dispatch" data-url="/dispatch/">
  <h3>Dispatch</h3>
  {% for order in orders %}
  {% if order.stage == 'dispatch' %}
  <div class="order" id="{{ order.id }}" draggable="true">{{ order.id }}</div>
  {% endif %}
  {% endfor %}
</div>

{% block js %}
<script>
function handleDragStart(event) {
  event.dataTransfer.setData("text/plain", event.target.id);
}

function handleDrop(event) {
  event.preventDefault();
  const orderId = event.dataTransfer.getData("text/plain");
  const orderElement = document.getElementById(orderId);
  const targetStageId = event.currentTarget.id;
  const targetStage = document.getElementById(targetStageId);

  targetStage.appendChild(orderElement);

  const order = getOrderFromDatabase(orderId);
  order.stage = targetStageId;

  const url = event.currentTarget.dataset.url;
  const xhr = new XMLHttpRequest();
  xhr.open('POST', url);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
  xhr.send(JSON.stringify({ id: orderId }));

  xhr.onreadystatechange = function () {
    if (xhr.readyState === XMLHttpRequest.DONE) {
      if (xhr.status === 200) {
        console.log("Request successful");
      } else {
        console.error("Error occurred during request");
      }
    }
  };
}

function handleDragOver(event) {
  event.preventDefault();
}

const orders = document.getElementsByClassName("order");
for (let i = 0; i < orders.length; i++) {
  orders[i].addEventListener("dragstart", handleDragStart);
}

const stages = document.getElementsByClassName("stage");
for (let i = 0; i < stages.length; i++) {
  stages[i].addEventListener("drop", handleDrop);
  stages[i].addEventListener("dragover", handleDragOver);
}

function getOrderFromDatabase(orderId) {
  return {
    id: orderId,
    stage: ""
  };
}
</script>
{% endblock %}
{% endblock %}
